<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© | Ù„ÙÙ…Ù‘Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <style>
        .admin-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
            background: var(--black);
        }

        .admin-nav {
            background: var(--gray-900);
            padding: var(--space-8);
            border-left: 1px solid #333;
        }

        .admin-content {
            padding: var(--space-10);
        }

        .nav-item {
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            color: var(--gray-400);
            font-weight: 700;
            margin-bottom: 10px;
            transition: 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--orange-500);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-card {
            background: var(--gray-900);
            padding: var(--space-8);
            border-radius: 20px;
            border: 1px solid #333;
            margin-bottom: 2rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray-400);
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            background: #000;
            border: 1px solid #333;
            color: white;
            border-radius: 8px;
        }

        .package-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: #000;
            border: 1px solid #333;
            border-radius: 12px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="auth-overlay"
        style="position: fixed; inset: 0; background: var(--black); z-index: 1000; display: flex; align-items: center; justify-content: center;">
        <div
            style="max-width: 400px; padding: var(--space-10); background: var(--gray-900); border-radius: 24px; border: 1px solid #333; text-align: center;">
            <h1 class="text-3xl font-black mb-8">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
            <input type="password" id="admin-pass" class="btn-block"
                style="padding: 15px; background: black; border: 1px solid #333; border-radius: 8px; margin-bottom: 20px; color: white;"
                placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="checkAdmin()" class="btn btn-primary btn-block">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„ÙˆØ­Ø©</button>
            <p class="text-xs text-gray-500 mt-4">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: admin123</p>
        </div>
    </div>

    <div id="main-admin" class="admin-layout" style="display: none;">
        <aside class="admin-nav">
            <div class="logo mb-10">Ù„ÙÙ…Ù‘Ø© <small>CMS</small></div>
            <div class="nav-item active" onclick="switchTab('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
            <div class="nav-item" onclick="switchTab('orders')">ğŸ›ï¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div class="nav-item" onclick="switchTab('products')">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</div>
            <div class="nav-item" onclick="switchTab('content')">ğŸ“ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
            <div class="nav-item" onclick="switchTab('payment')">ğŸ’³ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</div>
            <div class="nav-item" onclick="switchTab('database')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
            <button onclick="saveAll()" class="btn btn-primary btn-block">Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            <button onclick="location.href='index.html'" class="btn btn-outline btn-block mt-4">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</button>
        </aside>

        <main class="admin-content">
            <!-- Stats Tab -->
            <div id="tab-stats" class="tab-content active">
                <h2 class="text-4xl font-black mb-10">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div class="config-card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                        <div id="stat-total-orders" class="text-4xl font-black text-orange-500">...</div>
                    </div>
                    <div class="config-card">
                        <h3>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h3>
                        <div id="stat-monthly-revenue" class="text-4xl font-black text-orange-500">...</div>
                    </div>
                    <div class="config-card">
                        <h3>Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…</h3>
                        <div id="stat-today-visitors" class="text-4xl font-black text-orange-500">...</div>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="tab-orders" class="tab-content">
                <h2 class="text-4xl font-black mb-10">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                <div id="orders-list">
                    <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="tab-products" class="tab-content">
                <h2 class="text-4xl font-black mb-10">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</h2>
                <div id="packages-editor-list"></div>
                <button class="btn btn-outline btn-block" style="border-style: dashed;" onclick="addEmptyPackage()">+
                    Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>

            <!-- Content Tab -->
            <div id="tab-content" class="tab-content">
                <h2 class="text-4xl font-black mb-10">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
                <div class="config-card">
                    <div class="input-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‡ÙŠØ±Ùˆ (ÙŠØ¯Ø¹Ù… HTML)</label>
                        <input type="text" id="cfg-heroTitle">
                    </div>
                    <div class="input-group">
                        <label>ÙˆØµÙ Ø§Ù„Ù‡ÙŠØ±Ùˆ</label>
                        <textarea id="cfg-heroDesc" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Ù„ÙˆÙ† Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Hex)</label>
                        <input type="color" id="cfg-primaryColor" style="height: 50px;">
                    </div>
                    <div class="input-group">
                        <label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¯Ø¹Ù… (Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„ÙŠ Ø¨Ø¯ÙˆÙ† +)</label>
                        <input type="text" id="cfg-whatsapp">
                    </div>
                </div>
            </div>

            <!-- Payment Tab -->
            <div id="tab-payment" class="tab-content">
                <h2 class="text-4xl font-black mb-10">Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h2>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="config-card">
                        <h3>MTN Cash</h3>
                        <div class="input-group mt-4"><label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label><input type="text" id="pay-mtn-name">
                        </div>
                        <div class="input-group"><label>Ø±Ù‚Ù…/Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</label><input type="text" id="pay-mtn-account">
                        </div>
                    </div>
                    <div class="config-card">
                        <h3>Syriatel Cash</h3>
                        <div class="input-group mt-4"><label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label><input type="text"
                                id="pay-syriatel-name"></div>
                        <div class="input-group"><label>Ø±Ù‚Ù…/Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨</label><input type="text"
                                id="pay-syriatel-account"></div>
                    </div>
                    <div class="config-card">
                        <h3>USDT (TRC20)</h3>
                        <div class="input-group mt-4"><label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label><input type="text" id="pay-usdt-name">
                        </div>
                        <div class="input-group"><label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</label><input type="text" id="pay-usdt-account">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Tab -->
            <div id="tab-database" class="tab-content">
                <h2 class="text-4xl font-black mb-10">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Supabase)</h2>
                <div class="config-card">
                    <p class="text-sm text-gray-400 mb-6">Ø§Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Supabase Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª
                        Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.</p>
                    <div class="input-group">
                        <label>Supabase URL</label>
                        <input type="text" id="db-url" placeholder="https://xyz.supabase.co">
                    </div>
                    <div class="input-group">
                        <label>Supabase Anon Key</label>
                        <input type="password" id="db-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    </div>
                    <button onclick="saveDBConfig()" class="btn btn-outline">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø·</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/db.js"></script>

    <script>
        const auth = firebase.auth();

        // 1. Simple Password Check (Visual Guard)
        function checkAdmin() {
            const pass = document.getElementById('admin-pass').value;
            if (pass === 'admin123') {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('main-admin').style.display = 'grid';
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        }

        // 2. Auth Guard (Firebase Security)
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is authenticated with Firebase
                console.log("User authenticated:", user.email);
                loadConfig(); // Start loading data in background
            } else {
                // Not logged in, redirect to login page
                // We append a return URL if possible, or just redirect
                window.location.href = 'login.html?redirect=admin-dashboard.html';
            }
        });

        // 2. Data Loading with Error Handling
        let localPackages = [];
        let siteSettings = {};

        async function loadConfig() {
            try {
                // Indicate loading
                console.log("Loading Dashboard Data...");

                // Load Stats
                const stats = await db.getStats();
                document.getElementById('stat-total-orders').textContent = stats.totalOrders;
                document.getElementById('stat-monthly-revenue').textContent = stats.revenue.toLocaleString() + '$';
                document.getElementById('stat-today-visitors').textContent = stats.visitors;

                // Load Packages
                localPackages = await db.getPackages();

                // Load Settings
                siteSettings = await db.getSettings();

                // Load Orders
                loadOrders();

                // Populate UI
                populateSettingsUI();
                renderPackagesList();

            } catch (err) {
                console.error("Dashboard Load Error:", err);
                if (err.code === 'permission-denied') {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ "Firestore Security Rules" ÙÙŠ Firebase Console Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©.\n\n(allow read, write: if true; - Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)');
                } else {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.');
                }
            }
        }

        function populateSettingsUI() {
            // UI Updates
            document.getElementById('cfg-heroTitle').value = siteSettings.heroTitle || '';
            document.getElementById('cfg-heroDesc').value = siteSettings.heroDesc || '';
            document.getElementById('cfg-primaryColor').value = siteSettings.primaryColor || '#f97316';
            document.getElementById('cfg-whatsapp').value = siteSettings.whatsapp || '963953644710';

            // Load Payments
            const pm = siteSettings.paymentMethods || {};
            document.getElementById('pay-mtn-name').value = pm.mtn?.name || '';
            document.getElementById('pay-mtn-account').value = pm.mtn?.account || '';
            document.getElementById('pay-syriatel-name').value = pm.syriatel?.name || '';
            document.getElementById('pay-syriatel-account').value = pm.syriatel?.account || '';
            document.getElementById('pay-usdt-name').value = pm.usdt?.name || '';
            document.getElementById('pay-usdt-account').value = pm.usdt?.account || '';
        }

        async function loadOrders() {
            const list = document.getElementById('orders-list');
            try {
                const orders = await db.getOrders();
                if (orders.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                    return;
                }
                list.innerHTML = orders.map(order => `
                    <div class="config-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-xl">${order.recipient_name}</h4>
                                <p class="text-gray-400 text-sm">${order.recipient_phone} | ${order.address}</p>
                                <p class="text-xs text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨: ${order.created_at?.toDate().toLocaleString() || 'N/A'}</p>
                            </div>
                            <div class="text-left">
                                <span class="badge ${order.status === 'pending' ? 'bg-orange-500' : 'bg-green-500'} p-1 px-3 rounded-full text-xs">
                                    ${order.status === 'pending' ? 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯' : 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°'}
                                </span>
                                <div class="mt-2 font-bold text-xl">${order.total}$</div>
                            </div>
                        </div>
                        <div class="border-t border-white/5 pt-4 flex gap-4">
                            <div class="flex-grow">
                                <div class="text-xs text-gray-400 mb-2">Ø§Ù„Ø¹Ù†Ø§ØµØ±:</div>
                                ${order.items.map(item => `<div class="text-sm">â€¢ ${item.title}</div>`).join('')}
                            </div>
                            ${order.payment_proof_url ? `
                                <a href="${order.payment_proof_url}" target="_blank" class="w-20 h-20 border border-white/10 rounded overflow-hidden flex items-center justify-center">
                                    <img src="${order.payment_proof_url}" class="object-cover w-full h-full">
                                </a>
                            ` : ''}
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="updateStatus('${order.id}', 'completed')" class="btn btn-sm btn-primary">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</button>
                            <button onclick="updateStatus('${order.id}', 'rejected')" class="btn btn-sm btn-outline text-red-500">Ø±ÙØ¶</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p class="text-red-500">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.</p>';
            }
        }

        window.updateStatus = async (id, status) => {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
                await db.updateOrderStatus(id, status);
                loadOrders();
            }
        };

        function renderPackagesList() {
            const list = document.getElementById('packages-editor-list');
            list.innerHTML = localPackages.map((p, idx) => `
                <div class="config-card">
                    <div class="grid" style="grid-template-columns: 100px 1fr 150px 120px 50px; gap: 20px; align-items: center;">
                        <div style="text-align: center;">
                            <img src="${p.image}" id="img-preview-${idx}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; border: 1px solid #333;">
                            <div style="font-size: 9px; color: var(--orange-500); cursor: help; margin-top: 5px;" title="Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù†ØµÙŠ">Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ</div>
                        </div>
                        <div>
                            <input type="text" value="${p.title}" onchange="window.updatePkg(${idx}, 'title', this.value)" style="margin-bottom: 5px;" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©">
                            <textarea onchange="window.updatePkg(${idx}, 'desc', this.value)" rows="2" placeholder="ÙˆØµÙ Ø§Ù„Ø¨Ø§Ù‚Ø©">${p.desc || p.description || ''}</textarea>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 4px;">Ø§Ù„Ù‚Ø³Ù… ÙˆØ±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:</label>
                            <select onchange="window.updatePkg(${idx}, 'category', this.value)" style="width: 100%; padding: 8px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; margin-bottom: 5px;">
                                <option value="food" ${p.category === 'food' ? 'selected' : ''}>Ø§Ù„Ø³Ù„Ù„ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ÙˆØ¬Ø¨Ø§Øª</option>
                                <option value="gifts" ${p.category === 'gifts' ? 'selected' : ''}>Ø§Ù„ÙˆØ±ÙˆØ¯ ÙˆØ§Ù„Ø¹Ø·ÙˆØ±</option>
                                <option value="custom" ${p.category === 'custom' ? 'selected' : ''}>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</option>
                            </select>
                            <input type="text" value="${p.image}" onchange="window.updatePkg(${idx}, 'image', this.value)" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (http...)" style="font-size: 11px;">
                        </div>
                        <input type="text" value="${p.price}" onchange="window.updatePkg(${idx}, 'price', this.value)" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <button onclick="window.removePkg(${idx})" class="text-red-500" title="Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù‚Ø©">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        window.updatePkg = (idx, key, val) => {
            if (key === 'price' && !isNaN(val)) val = parseFloat(val);
            localPackages[idx][key] = val;

            // If image URL changed, update the preview instantly
            if (key === 'image') {
                const preview = document.getElementById(`img-preview-${idx}`);
                if (preview) preview.src = val;
            }
        };

        window.removePkg = (idx) => {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø§Ù‚Ø©ØŸ')) {
                localPackages.splice(idx, 1);
                renderPackagesList();
            }
        };

        window.addEmptyPackage = () => {
            localPackages.push({
                id: Date.now(),
                title: "Ø¨Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                desc: "ÙˆØµÙ Ø§Ù„Ø¨Ø§Ù‚Ø©",
                price: 0,
                image: "assets/img/hero.webp",
                category: "food"
            });
            renderPackagesList();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            // Find and activate the nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const clickAttr = item.getAttribute('onclick');
                if (clickAttr && clickAttr.includes(tab)) item.classList.add('active');
            });
        };

        window.saveAll = async () => {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                const updatedSettings = {
                    heroTitle: document.getElementById('cfg-heroTitle').value,
                    heroDesc: document.getElementById('cfg-heroDesc').value,
                    primaryColor: document.getElementById('cfg-primaryColor').value,
                    whatsapp: document.getElementById('cfg-whatsapp').value,
                    paymentMethods: {
                        mtn: { name: document.getElementById('pay-mtn-name').value, account: document.getElementById('pay-mtn-account').value, color: "#eab308", icon: "M" },
                        syriatel: { name: document.getElementById('pay-syriatel-name').value, account: document.getElementById('pay-syriatel-account').value, color: "#ef4444", icon: "S" },
                        usdt: { name: document.getElementById('pay-usdt-name').value, account: document.getElementById('pay-usdt-account').value, color: "#10b981", icon: "U" }
                    }
                };

                await db.saveSettings(updatedSettings);
                await db.savePackages(localPackages);

                alert('ØªÙ… Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                location.reload();
            } catch (err) {
                console.error("Save All Error:", err);
                let msg = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.';
                if (err.code === 'permission-denied') {
                    msg += '\n\nØ³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£: Firebase Rules ØªÙ…Ù†Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©. ÙŠØ±Ø¬Ù‰ Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ÙÙŠ Firestore Console.';
                } else {
                    msg += '\n\nØ§Ù„ØªÙØ§ØµÙŠÙ„: ' + err.message;
                }
                alert(msg);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ø­ÙØ¸ ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
            }
        };

        window.logout = async () => {
            await auth.signOut();
            location.reload();
        };
    </script>
</body>

</html>